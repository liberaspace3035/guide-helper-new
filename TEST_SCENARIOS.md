# ガイドヘルパーマッチングアプリケーション テストシナリオ

## 作成日
2024年12月

## 対象機能
- ユーザー登録・ログイン機能
- 依頼作成・管理機能
- マッチング機能
- 報告書管理機能

---

## 1. ユーザー登録・ログイン機能

### 1.1 状態遷移図

```
[未登録] 
  ↓ 登録
[登録済み・未承認] (is_allowed=false, email_confirmed=false)
  ↓ 管理者承認
[承認済み・未確認] (is_allowed=true, email_confirmed=false)
  ↓ メール確認
[承認済み・確認済み] (is_allowed=true, email_confirmed=true)
  ↓ ログイン
[ログイン中]
  ↓ ログアウト
[ログアウト]
```

### 1.2 考慮すべき境界値

- **メールアドレス**: 最大255文字、メール形式、重複チェック
- **パスワード**: 最小6文字、最大制限なし
- **名前**: 最大50文字（姓・名それぞれ）
- **カナ**: 最大50文字、カタカナのみ
- **郵便番号**: 形式 `###-####`（3桁-4桁）
- **電話番号**: 数字、ハイフン、括弧、プラス記号のみ
- **生年月日**: 過去日付のみ、未来日付は不可
- **年齢**: 生年月日から自動算出（0歳以上、上限なし）

### 1.3 テストケース

| ID | カテゴリ | シナリオ概要 | テスト手順 | 期待される結果 | 優先度 |
|---|---|---|---|---|---|
| REG-001 | 正常系 | ユーザー（視覚障害者）の新規登録が成功する | 1. 登録フォームにアクセス<br>2. ロール「user」を選択<br>3. 必須項目をすべて正しく入力<br>4. 登録ボタンをクリック | 登録成功メッセージが表示され、ログイン画面にリダイレクトされる。データベースにユーザーが作成され、is_allowed=false、email_confirmed=falseで保存される | 高 |
| REG-002 | 正常系 | ガイドの新規登録が成功する | 1. 登録フォームにアクセス<br>2. ロール「guide」を選択<br>3. 必須項目をすべて正しく入力（資格情報を含む）<br>4. 登録ボタンをクリック | 登録成功メッセージが表示され、ログイン画面にリダイレクトされる。データベースにガイドが作成され、is_allowed=false、email_confirmed=falseで保存される | 高 |
| REG-003 | 異常系 | メールアドレスが重複している場合、登録が拒否される | 1. 既存のメールアドレスで登録を試みる<br>2. 登録ボタンをクリック | バリデーションエラーが表示され、「このメールアドレスは既に使用されています」というメッセージが表示される | 高 |
| REG-004 | 異常系 | メールアドレス確認欄が一致しない場合、登録が拒否される | 1. メールアドレスを入力<br>2. メールアドレス確認欄に異なるメールアドレスを入力<br>3. 登録ボタンをクリック | バリデーションエラーが表示され、「メールアドレス確認欄が一致しません」というメッセージが表示される | 高 |
| REG-005 | 異常系 | パスワードが6文字未満の場合、登録が拒否される | 1. パスワードに5文字を入力<br>2. 登録ボタンをクリック | バリデーションエラーが表示され、「パスワードは6文字以上である必要があります」というメッセージが表示される | 高 |
| REG-006 | 異常系 | パスワード確認欄が一致しない場合、登録が拒否される | 1. パスワードを入力<br>2. パスワード確認欄に異なるパスワードを入力<br>3. 登録ボタンをクリック | バリデーションエラーが表示され、「パスワード確認欄が一致しません」というメッセージが表示される | 高 |
| REG-007 | 異常系 | 必須項目が未入力の場合、登録が拒否される | 1. 必須項目のいずれかを空欄のまま<br>2. 登録ボタンをクリック | バリデーションエラーが表示され、未入力の項目名が表示される | 高 |
| REG-008 | 異常系 | カナ名にカタカナ以外の文字が含まれている場合、登録が拒否される | 1. 姓カナまたは名カナにひらがなや漢字を入力<br>2. 登録ボタンをクリック | バリデーションエラーが表示され、「カナ名はカタカナのみ入力可能です」というメッセージが表示される | 中 |
| REG-009 | 異常系 | 郵便番号の形式が不正な場合、登録が拒否される | 1. 郵便番号に「1234567」や「12-3456」など不正な形式を入力<br>2. 登録ボタンをクリック | バリデーションエラーが表示され、「郵便番号は###-####形式で入力してください」というメッセージが表示される | 中 |
| REG-010 | 異常系 | 生年月日が未来日付の場合、登録が拒否される | 1. 生年月日に未来の日付を入力<br>2. 登録ボタンをクリック | バリデーションエラーが表示され、「生年月日は過去の日付である必要があります」というメッセージが表示される | 中 |
| REG-011 | 境界値 | 名前が最大長（50文字）の場合、登録が成功する | 1. 姓または名に50文字の文字列を入力<br>2. その他の必須項目を入力<br>3. 登録ボタンをクリック | 登録が成功する | 中 |
| REG-012 | 境界値 | 名前が最大長+1文字（51文字）の場合、登録が拒否される | 1. 姓または名に51文字の文字列を入力<br>2. 登録ボタンをクリック | バリデーションエラーが表示される | 中 |
| REG-013 | 境界値 | パスワードが最小長（6文字）の場合、登録が成功する | 1. パスワードに6文字を入力<br>2. その他の必須項目を入力<br>3. 登録ボタンをクリック | 登録が成功する | 中 |
| REG-014 | 境界値 | メールアドレスが最大長（255文字）の場合、登録が成功する | 1. メールアドレスに255文字の文字列を入力（有効なメール形式）<br>2. その他の必須項目を入力<br>3. 登録ボタンをクリック | 登録が成功する | 低 |
| REG-015 | 異常系 | メールアドレスが無効な形式の場合、登録が拒否される | 1. メールアドレスに「test@」や「test.com」など無効な形式を入力<br>2. 登録ボタンをクリック | バリデーションエラーが表示され、「有効なメールアドレスを入力してください」というメッセージが表示される | 高 |
| REG-016 | 正常系 | 承認済みユーザーがログインに成功する | 1. is_allowed=true、email_confirmed=trueのユーザーでログイン<br>2. 正しいメールアドレスとパスワードを入力<br>3. ログインボタンをクリック | ログインに成功し、ダッシュボードにリダイレクトされる | 高 |
| REG-017 | 異常系 | 未承認ユーザー（is_allowed=false）がログインを試みる場合、ログインが拒否される | 1. is_allowed=falseのユーザーでログインを試みる<br>2. 正しいメールアドレスとパスワードを入力<br>3. ログインボタンをクリック | エラーメッセージが表示され、「ユーザーは承認されていません」というメッセージが表示される | 高 |
| REG-018 | 異常系 | メールアドレスが存在しない場合、ログインが拒否される | 1. 存在しないメールアドレスを入力<br>2. パスワードを入力<br>3. ログインボタンをクリック | エラーメッセージが表示され、「メールアドレスまたはパスワードが正しくありません」というメッセージが表示される | 高 |
| REG-019 | 異常系 | パスワードが間違っている場合、ログインが拒否される | 1. 正しいメールアドレスを入力<br>2. 間違ったパスワードを入力<br>3. ログインボタンをクリック | エラーメッセージが表示され、「メールアドレスまたはパスワードが正しくありません」というメッセージが表示される | 高 |
| REG-020 | 異常系 | メールアドレスが空欄の場合、ログインが拒否される | 1. メールアドレスを空欄のまま<br>2. パスワードを入力<br>3. ログインボタンをクリック | バリデーションエラーが表示される | 高 |
| REG-021 | 異常系 | パスワードが空欄の場合、ログインが拒否される | 1. メールアドレスを入力<br>2. パスワードを空欄のまま<br>3. ログインボタンをクリック | バリデーションエラーが表示される | 高 |
| REG-022 | 正常系 | ログアウトが成功する | 1. ログイン状態でログアウトボタンをクリック | ログアウトに成功し、ホーム画面にリダイレクトされる。セッションが無効化される | 高 |
| REG-023 | エッジケース | SQLインジェクション攻撃を試みる（メールアドレスにSQL文を入力） | 1. メールアドレス欄に「' OR '1'='1」などを入力<br>2. 登録/ログインを試みる | SQLインジェクションが実行されず、バリデーションエラーまたは認証エラーが表示される | 高 |
| REG-024 | エッジケース | XSS攻撃を試みる（名前欄にスクリプトタグを入力） | 1. 名前欄に「<script>alert('XSS')</script>」を入力<br>2. 登録を試みる | XSSが実行されず、入力値がエスケープされて保存される | 高 |
| REG-025 | エッジケース | 非常に長いパスワード（1000文字以上）を入力する | 1. パスワードに1000文字以上の文字列を入力<br>2. 登録を試みる | システムが適切に処理し、エラーが発生しないか、適切なエラーメッセージが表示される | 低 |

---

## 2. 依頼作成・管理機能

### 2.1 状態遷移図

```
[依頼なし]
  ↓ 依頼作成
[pending] (承認待ち)
  ↓ ガイド承諾
[guide_accepted] (ガイド承諾済み)
  ↓ マッチング成立
[matched] (マッチング成立)
  ↓ サービス完了
[completed] (完了)
  ↓ キャンセル
[cancelled] (キャンセル)
```

### 2.2 考慮すべき境界値

- **依頼日**: 過去日付は不可、未来日付のみ
- **開始時刻・終了時刻**: HH:MM形式、終了時刻 > 開始時刻
- **所要時間**: 分単位、正の整数
- **住所**: テキスト形式、最大長制限なし
- **サービス内容**: テキスト形式、最大長制限なし
- **月次限度時間**: 依頼作成時に残時間チェック

### 2.3 テストケース

| ID | カテゴリ | シナリオ概要 | テスト手順 | 期待される結果 | 優先度 |
|---|---|---|---|---|---|
| REQ-001 | 正常系 | ユーザーが外出依頼を正常に作成できる | 1. ログイン済みユーザーで依頼作成画面にアクセス<br>2. 依頼タイプ「外出」を選択<br>3. 必須項目をすべて入力（目的地住所、サービス内容、依頼日時など）<br>4. 依頼作成ボタンをクリック | 依頼が作成され、ステータスが「pending」で保存される。マスキング済み住所が生成される | 高 |
| REQ-002 | 正常系 | ユーザーが自宅依頼を正常に作成できる | 1. ログイン済みユーザーで依頼作成画面にアクセス<br>2. 依頼タイプ「自宅」を選択<br>3. 必須項目をすべて入力<br>4. 依頼作成ボタンをクリック | 依頼が作成され、ステータスが「pending」で保存される | 高 |
| REQ-003 | 正常系 | 指名ガイドを指定して依頼を作成できる | 1. 依頼作成画面でガイドを指名<br>2. 必須項目を入力<br>3. 依頼作成ボタンをクリック | 依頼が作成され、nominated_guide_idが保存される。指名ガイドに通知が送信される | 高 |
| REQ-004 | 正常系 | 音声入力（AI整形）機能を使用して依頼を作成できる | 1. 備考欄で音声入力を選択<br>2. 音声入力テキストを入力<br>3. AI整形を実行<br>4. 依頼作成ボタンをクリック | 音声入力テキストがAIで整形され、formatted_notesに保存される | 中 |
| REQ-005 | 異常系 | 依頼日が過去日付の場合、依頼作成が拒否される | 1. 依頼日に過去の日付を入力<br>2. 依頼作成ボタンをクリック | バリデーションエラーが表示され、「依頼日は未来の日付である必要があります」というメッセージが表示される | 高 |
| REQ-006 | 異常系 | 終了時刻が開始時刻より前の場合、依頼作成が拒否される | 1. 開始時刻に「14:00」を入力<br>2. 終了時刻に「13:00」を入力<br>3. 依頼作成ボタンをクリック | バリデーションエラーが表示され、「終了時刻は開始時刻より後である必要があります」というメッセージが表示される | 高 |
| REQ-007 | 異常系 | 必須項目が未入力の場合、依頼作成が拒否される | 1. 必須項目のいずれかを空欄のまま<br>2. 依頼作成ボタンをクリック | バリデーションエラーが表示され、未入力の項目名が表示される | 高 |
| REQ-008 | 異常系 | 承認待ちの報告書がある場合、新規依頼作成が拒否される | 1. ステータス「submitted」の報告書が存在するユーザーでログイン<br>2. 依頼作成画面にアクセス<br>3. 依頼作成を試みる | エラーメッセージが表示され、「承認待ちの報告書があります。承認または修正依頼を完了してから新しい依頼を作成してください」というメッセージが表示される | 高 |
| REQ-009 | 異常系 | 月次限度時間の残時間が不足している場合、依頼作成が拒否される | 1. 残時間が10時間のユーザーでログイン<br>2. 所要時間が15時間の依頼を作成しようとする<br>3. 依頼作成ボタンをクリック | エラーメッセージが表示され、「残時間が不足しています」というメッセージが表示される | 高 |
| REQ-010 | 境界値 | 残時間がちょうど必要な時間の場合、依頼作成が成功する | 1. 残時間が10時間のユーザーでログイン<br>2. 所要時間が10時間の依頼を作成<br>3. 依頼作成ボタンをクリック | 依頼が作成される | 中 |
| REQ-011 | 境界値 | 残時間が所要時間より少し多い場合、依頼作成が成功する | 1. 残時間が10.1時間のユーザーでログイン<br>2. 所要時間が10時間の依頼を作成<br>3. 依頼作成ボタンをクリック | 依頼が作成される | 中 |
| REQ-012 | 異常系 | 指名ガイドが存在しない場合、依頼作成が拒否される | 1. 存在しないガイドIDを指定<br>2. 依頼作成を試みる | エラーメッセージが表示される | 中 |
| REQ-013 | 異常系 | 指名ガイドが未承認（is_allowed=false）の場合、依頼作成が拒否される | 1. 未承認のガイドを指名<br>2. 依頼作成を試みる | エラーメッセージが表示される | 中 |
| REQ-014 | 正常系 | 希望ガイド条件（性別、年齢）を指定して依頼を作成できる | 1. 希望ガイド性別を選択<br>2. 希望ガイド年齢を入力<br>3. 依頼作成ボタンをクリック | 依頼が作成され、希望条件が保存される | 中 |
| REQ-015 | 正常系 | 待ち合わせ場所を指定して依頼を作成できる | 1. 待ち合わせ場所を入力<br>2. 依頼作成ボタンをクリック | 依頼が作成され、待ち合わせ場所が保存される | 中 |
| REQ-016 | 正常系 | ユーザーが自分の依頼一覧を確認できる | 1. ログイン済みユーザーで依頼一覧画面にアクセス | 自分の依頼のみが表示される | 高 |
| REQ-017 | 正常系 | ユーザーが依頼詳細を確認できる | 1. 依頼一覧から依頼を選択<br>2. 依頼詳細画面にアクセス | 依頼の詳細情報が表示される。住所はマスキングされている | 高 |
| REQ-018 | 正常系 | ユーザーが依頼をキャンセルできる | 1. ステータス「pending」の依頼を選択<br>2. キャンセルボタンをクリック<br>3. 確認ダイアログで「はい」を選択 | 依頼のステータスが「cancelled」に更新される | 中 |
| REQ-019 | 異常系 | マッチング成立済みの依頼をキャンセルしようとする場合、キャンセルが拒否される | 1. ステータス「matched」の依頼を選択<br>2. キャンセルを試みる | エラーメッセージが表示され、「マッチング成立済みの依頼はキャンセルできません」というメッセージが表示される | 中 |
| REQ-020 | エッジケース | 依頼日が今日の場合、依頼作成が成功する | 1. 依頼日に今日の日付を入力<br>2. 依頼作成ボタンをクリック | 依頼が作成される（仕様により、過去日付のみ不可） | 中 |
| REQ-021 | エッジケース | 開始時刻と終了時刻が同じ場合、依頼作成が拒否される | 1. 開始時刻と終了時刻に同じ時刻を入力<br>2. 依頼作成ボタンをクリック | バリデーションエラーが表示される | 中 |
| REQ-022 | エッジケース | 終了時刻が翌日になる場合（例：23:00 → 01:00）、依頼作成が成功する | 1. 開始時刻に「23:00」を入力<br>2. 終了時刻に「01:00」を入力<br>3. 依頼作成ボタンをクリック | 依頼が作成される（システムが翌日とみなす） | 低 |
| REQ-023 | エッジケース | 非常に長いサービス内容（10000文字以上）を入力する | 1. サービス内容に10000文字以上のテキストを入力<br>2. 依頼作成ボタンをクリック | システムが適切に処理し、エラーが発生しないか、適切なエラーメッセージが表示される | 低 |
| REQ-024 | セキュリティ | 他のユーザーの依頼を閲覧しようとする場合、アクセスが拒否される | 1. ユーザーAでログイン<br>2. ユーザーBの依頼IDを直接URLに指定してアクセス | 403エラーまたは適切なエラーメッセージが表示される | 高 |
| REQ-025 | セキュリティ | 未ログイン状態で依頼作成画面にアクセスしようとする場合、ログイン画面にリダイレクトされる | 1. ログアウト状態で依頼作成画面のURLにアクセス | ログイン画面にリダイレクトされる | 高 |

---

## 3. マッチング機能

### 3.1 状態遷移図

#### 自動マッチングON時
```
[依頼作成] (pending)
  ↓ ガイド承諾
[ガイド承諾] (guide_accepted)
  ↓ 自動マッチング
[マッチング成立] (matched)
  ↓ サービス実施
[進行中] (in_progress)
  ↓ 報告書完了
[完了] (completed)
```

#### 自動マッチングOFF時
```
[依頼作成] (pending)
  ↓ ガイド承諾
[ガイド承諾] (guide_accepted, admin_decision=pending)
  ↓ 管理者承認待ち
[管理者承認待ち] (admin_decision=pending)
  ↓ 管理者承認
[マッチング成立] (matched, admin_decision=approved)
  ↓ サービス実施
[進行中] (in_progress)
  ↓ 報告書完了
[完了] (completed)
```

### 3.2 考慮すべき境界値

- **ガイド承諾数**: 1つの依頼に対して複数のガイドが承諾可能
- **ユーザー選択**: 複数の応募者から1人を選択
- **自動マッチング設定**: ON/OFF切り替え可能

### 3.3 テストケース

| ID | カテゴリ | シナリオ概要 | テスト手順 | 期待される結果 | 優先度 |
|---|---|---|---|---|---|
| MAT-001 | 正常系 | 自動マッチングON時、ガイドが依頼を承諾すると即座にマッチング成立する | 1. 自動マッチング設定をONにする<br>2. ガイドが依頼を承諾<br>3. マッチング状態を確認 | マッチングが即座に成立し、ステータスが「matched」になる。ユーザーとガイドに通知が送信される | 高 |
| MAT-002 | 正常系 | 自動マッチングOFF時、ガイドが依頼を承諾すると管理者承認待ちになる | 1. 自動マッチング設定をOFFにする<br>2. ガイドが依頼を承諾<br>3. マッチング状態を確認 | マッチングが成立せず、admin_decisionが「pending」になる。管理者に通知が送信される | 高 |
| MAT-003 | 正常系 | 管理者が承認するとマッチングが成立する | 1. 自動マッチングOFF状態でガイドが承諾<br>2. 管理者が承認ボタンをクリック | マッチングが成立し、ステータスが「matched」になる。ユーザーとガイドに通知が送信される | 高 |
| MAT-004 | 正常系 | 管理者が却下するとマッチングが成立しない | 1. 自動マッチングOFF状態でガイドが承諾<br>2. 管理者が却下ボタンをクリック | マッチングが成立せず、admin_decisionが「rejected」になる。ガイドに通知が送信される | 高 |
| MAT-005 | 正常系 | 複数のガイドが同じ依頼に承諾できる | 1. 依頼を作成<br>2. ガイドAが承諾<br>3. ガイドBが承諾<br>4. ガイドCが承諾 | 3人のガイドがすべて承諾状態になる。ユーザーは応募者一覧で3人を確認できる | 高 |
| MAT-006 | 正常系 | ユーザーが応募者からガイドを選択できる | 1. 複数のガイドが承諾した依頼を選択<br>2. 応募者一覧からガイドを選択<br>3. 選択ボタンをクリック | 選択したガイドとのマッチングが成立する（自動マッチングON時は即座に、OFF時は管理者承認待ち） | 高 |
| MAT-007 | 正常系 | 指名依頼の場合、指名ガイドに優先的に通知が送信される | 1. 指名ガイドを指定して依頼を作成<br>2. 通知を確認 | 指名ガイドに「指名依頼が作成されました」という通知が送信される | 中 |
| MAT-008 | 正常系 | 指名依頼の場合、指名ガイドのみに通知が送信される | 1. 指名ガイドを指定して依頼を作成<br>2. 他のガイドの通知を確認 | 指名ガイド以外には通知が送信されない | 中 |
| MAT-009 | 異常系 | ガイドが自分の依頼に承諾しようとする場合、承諾が拒否される | 1. ユーザーとして依頼を作成<br>2. 同じアカウントでガイドとしてログイン<br>3. 自分の依頼に承諾を試みる | エラーメッセージが表示され、「自分の依頼には承諾できません」というメッセージが表示される | 高 |
| MAT-010 | 異常系 | ガイドが対応可能エリア外の依頼に承諾しようとする場合、承諾が拒否される | 1. ガイドの対応可能エリアを設定<br>2. エリア外の依頼に承諾を試みる | エラーメッセージが表示されるか、依頼が表示されない | 中 |
| MAT-011 | 異常系 | ガイドが対応可能日時外の依頼に承諾しようとする場合、承諾が拒否される | 1. ガイドの対応可能日時を設定<br>2. 日時外の依頼に承諾を試みる | エラーメッセージが表示されるか、依頼が表示されない | 中 |
| MAT-012 | 異常系 | 既にマッチング成立済みの依頼に他のガイドが承諾しようとする場合、承諾が拒否される | 1. 依頼にガイドAが承諾し、マッチング成立<br>2. ガイドBが同じ依頼に承諾を試みる | エラーメッセージが表示され、「この依頼は既にマッチング成立済みです」というメッセージが表示される | 高 |
| MAT-013 | 異常系 | キャンセル済みの依頼にガイドが承諾しようとする場合、承諾が拒否される | 1. 依頼をキャンセル<br>2. ガイドが承諾を試みる | エラーメッセージが表示されるか、依頼が表示されない | 中 |
| MAT-014 | 正常系 | マッチング成立後、チャット機能が利用可能になる | 1. マッチングを成立させる<br>2. チャット画面にアクセス | チャット画面が表示され、メッセージ送信が可能になる | 高 |
| MAT-015 | 正常系 | 報告書完了後、チャット機能が利用不可になる | 1. マッチングを成立させる<br>2. 報告書を作成・提出・承認（管理者承認まで）<br>3. チャット画面にアクセス | エラーメッセージが表示され、「報告書が承認済みのため、チャットは利用できません」というメッセージが表示される | 高 |
| MAT-016 | 正常系 | マッチング一覧で自分のマッチングを確認できる | 1. ログイン済みユーザー/ガイドでマッチング一覧にアクセス | 自分のマッチングのみが表示される | 高 |
| MAT-017 | 正常系 | マッチング詳細を確認できる | 1. マッチング一覧からマッチングを選択<br>2. マッチング詳細画面にアクセス | マッチングの詳細情報が表示される | 高 |
| MAT-018 | 正常系 | マッチングをキャンセルできる | 1. ステータス「matched」のマッチングを選択<br>2. キャンセルボタンをクリック<br>3. 確認ダイアログで「はい」を選択 | マッチングのステータスが「cancelled」に更新される | 中 |
| MAT-019 | 異常系 | 報告書が提出済みのマッチングをキャンセルしようとする場合、キャンセルが拒否される | 1. 報告書が提出済みのマッチングを選択<br>2. キャンセルを試みる | エラーメッセージが表示され、「報告書が提出済みのマッチングはキャンセルできません」というメッセージが表示される | 中 |
| MAT-020 | エッジケース | 同時に複数のガイドが同じ依頼に承諾しようとする場合、すべての承諾が記録される | 1. 複数のガイドが同時に同じ依頼に承諾<br>2. 承諾状態を確認 | すべてのガイドの承諾が記録される（競合状態が適切に処理される） | 中 |
| MAT-021 | エッジケース | 自動マッチング設定をON/OFF切り替え中にガイドが承諾した場合、適切に処理される | 1. 自動マッチング設定を切り替え中<br>2. ガイドが承諾 | 設定変更時の状態に応じて適切に処理される | 低 |
| MAT-022 | セキュリティ | 他のユーザーのマッチングを閲覧しようとする場合、アクセスが拒否される | 1. ユーザーAでログイン<br>2. ユーザーBのマッチングIDを直接URLに指定してアクセス | 403エラーまたは適切なエラーメッセージが表示される | 高 |
| MAT-023 | セキュリティ | 未ログイン状態でマッチング一覧にアクセスしようとする場合、ログイン画面にリダイレクトされる | 1. ログアウト状態でマッチング一覧のURLにアクセス | ログイン画面にリダイレクトされる | 高 |

---

## 4. 報告書管理機能

### 4.1 状態遷移図

```
[マッチング成立] (matched)
  ↓ ガイドが報告書作成
[draft] (下書き)
  ↓ ガイドが提出
[submitted] (提出済み・ユーザー承認待ち)
  ↓ ユーザー承認
[user_approved] (ユーザー承認済み・管理者承認待ち)
  ↓ 管理者承認
[admin_approved] (管理者承認済み・確定)
  ↓ 利用時間計上
[完了]
```

または

```
[submitted] (提出済み)
  ↓ ユーザーが修正依頼
[revision_requested] (修正依頼中)
  ↓ ガイドが修正・再提出
[submitted] (再提出)
  ↓ ユーザー承認
[user_approved]
  ↓ 管理者承認
[admin_approved]
```

### 4.2 考慮すべき境界値

- **実施日**: 依頼日に固定、変更不可
- **開始時刻・終了時刻**: HH:MM形式、終了時刻 > 開始時刻
- **利用時間**: 分単位で計算、時間に変換（小数点第1位まで）
- **報告書ステータス**: 各ステータスでの操作制限

### 4.3 テストケース

| ID | カテゴリ | シナリオ概要 | テスト手順 | 期待される結果 | 優先度 |
|---|---|---|---|---|---|
| REP-001 | 正常系 | ガイドが報告書を作成できる | 1. マッチング成立済みの依頼を選択<br>2. 報告書作成画面にアクセス<br>3. 必須項目を入力（サービス内容、報告内容、実施日時など）<br>4. 保存ボタンをクリック | 報告書が作成され、ステータスが「draft」で保存される | 高 |
| REP-002 | 正常系 | ガイドが報告書を提出できる | 1. ステータス「draft」の報告書を選択<br>2. 提出ボタンをクリック | 報告書のステータスが「submitted」に更新される。ユーザーに通知が送信される | 高 |
| REP-003 | 正常系 | ユーザーが報告書を承認できる | 1. ステータス「submitted」の報告書を選択<br>2. 承認ボタンをクリック | 報告書のステータスが「user_approved」に更新される。ガイドと管理者に通知が送信される | 高 |
| REP-004 | 正常系 | ユーザーが報告書に修正依頼できる | 1. ステータス「submitted」の報告書を選択<br>2. 修正依頼ボタンをクリック<br>3. 修正依頼コメントを入力<br>4. 送信ボタンをクリック | 報告書のステータスが「revision_requested」に更新される。修正依頼コメントが保存される。ガイドに通知が送信される | 高 |
| REP-005 | 正常系 | ガイドが修正依頼を受けて報告書を修正・再提出できる | 1. ステータス「revision_requested」の報告書を選択<br>2. 報告書を修正<br>3. 再提出ボタンをクリック | 報告書が修正され、ステータスが「submitted」に戻る。ユーザーに通知が送信される | 高 |
| REP-006 | 正常系 | 管理者が報告書を承認できる | 1. ステータス「user_approved」の報告書を選択<br>2. 承認ボタンをクリック | 報告書のステータスが「admin_approved」に更新される。利用時間が計上される。マッチングのreport_completed_atが更新される。ユーザーとガイドに通知が送信される | 高 |
| REP-007 | 異常系 | 実施日を変更しようとする場合、変更が拒否される | 1. 報告書作成画面で実施日を変更しようとする | 実施日が変更できない（依頼日に固定） | 高 |
| REP-008 | 異常系 | 終了時刻が開始時刻より前の場合、報告書作成が拒否される | 1. 開始時刻に「14:00」を入力<br>2. 終了時刻に「13:00」を入力<br>3. 保存ボタンをクリック | バリデーションエラーが表示される | 高 |
| REP-009 | 異常系 | 必須項目が未入力の場合、報告書作成が拒否される | 1. 必須項目のいずれかを空欄のまま<br>2. 保存ボタンをクリック | バリデーションエラーが表示される | 高 |
| REP-010 | 異常系 | 既に承認済みの報告書を修正しようとする場合、修正が拒否される | 1. ステータス「admin_approved」の報告書を選択<br>2. 修正を試みる | エラーメッセージが表示され、「既に承認済みの報告書です」というメッセージが表示される | 高 |
| REP-011 | 異常系 | 提出済みの報告書を直接編集しようとする場合、編集が拒否される | 1. ステータス「submitted」の報告書を選択<br>2. 直接編集を試みる | エラーメッセージが表示されるか、編集画面が表示されない | 中 |
| REP-012 | 異常系 | マッチング成立前の依頼で報告書を作成しようとする場合、作成が拒否される | 1. ステータス「pending」の依頼で報告書作成を試みる | エラーメッセージが表示される | 高 |
| REP-013 | 正常系 | 利用時間が正しく計上される | 1. 開始時刻「10:00」、終了時刻「12:00」の報告書を作成<br>2. 管理者が承認 | 利用時間が2.0時間として計上される | 高 |
| REP-014 | 正常系 | 翌日にまたがる時間（例：23:00 → 01:00）が正しく計算される | 1. 開始時刻「23:00」、終了時刻「01:00」の報告書を作成<br>2. 管理者が承認 | 利用時間が2.0時間として計上される | 中 |
| REP-015 | 正常系 | 小数点を含む時間（例：10:30 → 12:45）が正しく計算される | 1. 開始時刻「10:30」、終了時刻「12:45」の報告書を作成<br>2. 管理者が承認 | 利用時間が2.3時間（2時間15分）として計上される | 中 |
| REP-016 | 正常系 | 月次限度時間の使用時間が正しく更新される | 1. 報告書を作成・承認<br>2. ユーザーの月次限度時間を確認 | 使用時間が報告書の利用時間分だけ増加している | 高 |
| REP-017 | 正常系 | ガイドが自分の報告書一覧を確認できる | 1. ログイン済みガイドで報告書一覧にアクセス | 自分の報告書のみが表示される | 高 |
| REP-018 | 正常系 | ユーザーが自分の報告書一覧を確認できる | 1. ログイン済みユーザーで報告書一覧にアクセス | 自分の報告書のみが表示される | 高 |
| REP-019 | 正常系 | 管理者がすべての報告書一覧を確認できる | 1. ログイン済み管理者で報告書一覧にアクセス | すべての報告書が表示される | 高 |
| REP-020 | 正常系 | 報告書詳細を確認できる | 1. 報告書一覧から報告書を選択<br>2. 報告書詳細画面にアクセス | 報告書の詳細情報が表示される | 高 |
| REP-021 | 異常系 | 他のガイドの報告書を編集しようとする場合、編集が拒否される | 1. ガイドAでログイン<br>2. ガイドBの報告書IDを直接URLに指定してアクセス | 403エラーまたは適切なエラーメッセージが表示される | 高 |
| REP-022 | 異常系 | 他のユーザーの報告書を承認しようとする場合、承認が拒否される | 1. ユーザーAでログイン<br>2. ユーザーBの報告書IDを直接URLに指定して承認を試みる | 403エラーまたは適切なエラーメッセージが表示される | 高 |
| REP-023 | エッジケース | 開始時刻と終了時刻が同じ場合、報告書作成が拒否される | 1. 開始時刻と終了時刻に同じ時刻を入力<br>2. 保存ボタンをクリック | バリデーションエラーが表示される | 中 |
| REP-024 | エッジケース | 非常に短い時間（1分）の報告書を作成する | 1. 開始時刻「10:00」、終了時刻「10:01」の報告書を作成<br>2. 管理者が承認 | 利用時間が0.0時間または0.1時間として計上される | 低 |
| REP-025 | エッジケース | 非常に長い時間（24時間以上）の報告書を作成する | 1. 開始時刻「10:00」、終了時刻「翌日10:00」の報告書を作成<br>2. 管理者が承認 | 利用時間が24.0時間として計上される | 低 |
| REP-026 | エッジケース | 複数回修正依頼が発生する場合、すべての修正履歴が記録される | 1. 報告書を提出<br>2. ユーザーが修正依頼<br>3. ガイドが修正・再提出<br>4. 再度修正依頼<br>5. 再度修正・再提出 | すべての修正履歴が記録される | 中 |
| REP-027 | 正常系 | 報告書が承認されると、マッチングのreport_completed_atが更新される | 1. 報告書を作成・提出・承認（管理者承認まで）<br>2. マッチングのreport_completed_atを確認 | report_completed_atが更新されている | 高 |
| REP-028 | 正常系 | 報告書が承認されると、チャット機能が利用不可になる | 1. 報告書を作成・提出・承認（管理者承認まで）<br>2. チャット画面にアクセス | エラーメッセージが表示され、「報告書が承認済みのため、チャットは利用できません」というメッセージが表示される | 高 |
| REP-029 | セキュリティ | 未ログイン状態で報告書一覧にアクセスしようとする場合、ログイン画面にリダイレクトされる | 1. ログアウト状態で報告書一覧のURLにアクセス | ログイン画面にリダイレクトされる | 高 |
| REP-030 | セキュリティ | SQLインジェクション攻撃を試みる（報告内容にSQL文を入力） | 1. 報告内容に「' OR '1'='1」などを入力<br>2. 保存を試みる | SQLインジェクションが実行されず、入力値がエスケープされて保存される | 高 |

---

## 5. 総合テストシナリオ

### 5.1 エンドツーエンドシナリオ

| ID | カテゴリ | シナリオ概要 | テスト手順 | 期待される結果 | 優先度 |
|---|---|---|---|---|---|
| E2E-001 | 正常系 | 完全なフロー：ユーザー登録→依頼作成→マッチング→報告書→承認 | 1. ユーザー登録<br>2. 管理者が承認<br>3. ユーザーがログイン<br>4. 依頼を作成<br>5. ガイドが承諾<br>6. マッチング成立<br>7. ガイドが報告書を作成・提出<br>8. ユーザーが承認<br>9. 管理者が承認<br>10. 利用時間が計上される | すべてのステップが正常に完了し、最終的に利用時間が計上される | 高 |
| E2E-002 | 正常系 | 修正依頼フロー：報告書提出→修正依頼→修正・再提出→承認 | 1. ガイドが報告書を作成・提出<br>2. ユーザーが修正依頼<br>3. ガイドが修正・再提出<br>4. ユーザーが承認<br>5. 管理者が承認 | すべてのステップが正常に完了する | 高 |
| E2E-003 | 正常系 | 指名依頼フロー：指名依頼作成→指名ガイド承諾→マッチング成立 | 1. ユーザーが指名ガイドを指定して依頼を作成<br>2. 指名ガイドが承諾<br>3. マッチング成立 | 指名ガイドとのマッチングが成立する | 中 |
| E2E-004 | 正常系 | 複数応募者フロー：複数ガイド承諾→ユーザー選択→マッチング成立 | 1. 依頼を作成<br>2. 複数のガイドが承諾<br>3. ユーザーが応募者から選択<br>4. マッチング成立 | 選択したガイドとのマッチングが成立する | 中 |
| E2E-005 | 異常系 | 残時間不足フロー：残時間不足→依頼作成拒否 | 1. 残時間が5時間のユーザーでログイン<br>2. 所要時間が10時間の依頼を作成しようとする | 依頼作成が拒否され、エラーメッセージが表示される | 高 |
| E2E-006 | 異常系 | 承認待ち報告書フロー：承認待ち報告書がある状態で新規依頼作成を試みる | 1. 承認待ちの報告書があるユーザーでログイン<br>2. 新規依頼を作成しようとする | 依頼作成が拒否され、エラーメッセージが表示される | 高 |

---

## 6. パフォーマンス・負荷テスト

| ID | カテゴリ | シナリオ概要 | テスト手順 | 期待される結果 | 優先度 |
|---|---|---|---|---|---|
| PERF-001 | パフォーマンス | 大量の依頼がある場合、一覧表示が適切な時間内に完了する | 1. 1000件の依頼を作成<br>2. 依頼一覧画面にアクセス<br>3. 表示時間を測定 | 3秒以内に一覧が表示される | 中 |
| PERF-002 | パフォーマンス | 大量のマッチングがある場合、一覧表示が適切な時間内に完了する | 1. 1000件のマッチングを作成<br>2. マッチング一覧画面にアクセス<br>3. 表示時間を測定 | 3秒以内に一覧が表示される | 中 |
| PERF-003 | パフォーマンス | 同時に複数のユーザーが依頼を作成する場合、すべての依頼が正しく作成される | 1. 10人のユーザーが同時に依頼を作成<br>2. すべての依頼を確認 | すべての依頼が正しく作成される | 中 |
| PERF-004 | パフォーマンス | 大量のチャットメッセージがある場合、メッセージ一覧が適切な時間内に表示される | 1. 1000件のメッセージを作成<br>2. チャット画面にアクセス<br>3. 表示時間を測定 | 3秒以内にメッセージ一覧が表示される | 低 |

---

## 7. セキュリティテスト

| ID | カテゴリ | シナリオ概要 | テスト手順 | 期待される結果 | 優先度 |
|---|---|---|---|---|---|
| SEC-001 | セキュリティ | CSRF攻撃を試みる場合、リクエストが拒否される | 1. CSRFトークンなしでPOSTリクエストを送信 | 419エラーまたは適切なエラーメッセージが表示される | 高 |
| SEC-002 | セキュリティ | セッションハイジャック攻撃を試みる場合、セッションが無効化される | 1. 有効なセッションIDを取得<br>2. 別のブラウザから同じセッションIDでアクセス | セッションが無効化され、ログイン画面にリダイレクトされる | 高 |
| SEC-003 | セキュリティ | パスワードがハッシュ化されて保存される | 1. ユーザーを登録<br>2. データベースでパスワードを確認 | パスワードがハッシュ化されて保存されている（平文ではない） | 高 |
| SEC-004 | セキュリティ | 住所情報がマスキングされて表示される | 1. 依頼を作成<br>2. 依頼一覧で住所を確認 | 住所がマスキングされて表示される | 高 |
| SEC-005 | セキュリティ | 権限のない操作を試みる場合、アクセスが拒否される | 1. ユーザーとしてログイン<br>2. 管理者専用のURLにアクセス | 403エラーまたは適切なエラーメッセージが表示される | 高 |

---

## テスト実行時の注意事項

1. **テスト環境**: 本番環境とは別のテスト環境で実行すること
2. **データクリーンアップ**: 各テストケース実行後、テストデータをクリーンアップすること
3. **ロールバック**: データベースの変更はトランザクションでロールバック可能にすること
4. **ログ確認**: エラーが発生した場合、ログファイルを確認すること
5. **ブラウザ互換性**: 主要ブラウザ（Chrome、Firefox、Safari、Edge）で動作確認すること
6. **アクセシビリティ**: スクリーンリーダーでの動作確認も行うこと

---

## テスト結果記録フォーマット

| テストID | 実行日時 | 実行者 | 結果 | 備考 |
|---|---|---|---|---|
| REG-001 | 2024/12/XX XX:XX | [実行者名] | ✅/❌ | [備考] |

---

## 更新履歴

- 2024年12月: 初版作成


