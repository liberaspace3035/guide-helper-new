# 管理者画面変更の影響範囲

## 変更日
2026年2月

## 概要
管理者画面における以下の変更を実施しました。

### 変更内容
1. **受給者証番号・従業員番号のバリデーション追加**
   - **受給者証番号**: 半角数字10桁のみ許可
   - **従業員番号**: 000-000形式（半角数字6桁をハイフンで区切る）のみ許可

2. **お知らせ一覧表示の修正**
   - タイトル欄に本文が表示されていた問題を修正
   - タイトル欄にはタイトルのみを表示するように変更

3. **メールテンプレート管理機能の改善**
   - テンプレート一覧に送信先情報（ユーザー/ガイド/両方）を表示
   - 送信タイミング（トリガー）の説明を表示
   - 新規テンプレート作成時に送信先を選択可能
   - 不足していたテンプレートを追加（登録お礼、当日リマインド、前日リマインド、報告書未提出リマインド）

4. **承諾待ち一覧の一括承認機能追加**
   - チェックボックスによる複数選択機能
   - 全選択/全解除機能
   - 選択された承諾の一括承認機能
   - ユーザーが選択していない承諾は選択不可（説明付き）

5. **承諾待ち一覧の非表示設定機能追加**
   - 長期間承認されていないデータを非表示にする機能
   - 日数設定（30日/60日/90日/180日から選択可能）
   - 設定はローカルストレージに保存され、次回訪問時も維持
   - フィルタリング後の件数表示

---

## 変更されたファイル

### 1. バックエンド
- `app/Http/Controllers/Api/AdminController.php`
  - `updateUserProfileExtra()`: 受給者証番号のバリデーション追加
  - `updateUserProfile()`: 受給者証番号のバリデーション追加
  - `updateGuideProfileExtra()`: 従業員番号のバリデーション追加
  - `updateGuideProfile()`: 従業員番号のバリデーション追加

### 2. フロントエンド
- `resources/views/admin/dashboard.blade.php`
  - 受給者証番号入力フィールド: 入力制御とバリデーション追加
  - 従業員番号入力フィールド: 自動フォーマット機能追加
  - エラーハンドリング改善

- `resources/views/admin/announcement-management.blade.php`
  - お知らせ一覧テーブル: タイトル欄の表示を修正
  - タイトル欄から本文プレビューを削除し、タイトルのみを表示

- `resources/views/admin/dashboard.blade.php`
  - メールテンプレート一覧: 送信先バッジとトリガー説明を追加
  - 新規テンプレート作成フォーム: 送信先選択フィールドを追加
  - テンプレートキー入力時の自動判定機能を追加
  - 承諾待ち一覧: チェックボックス列と一括承認ボタンを追加
  - 承諾待ち一覧: 全選択/全解除機能を追加
  - 承諾待ち一覧: ヒントアイコンと説明を追加
  - 承諾待ち一覧: 非表示設定UI（チェックボックス + 日数選択）を追加
  - 承諾待ち一覧: フィルタリング機能を追加

- `resources/css/Dashboard.scss`
  - 送信先バッジのスタイル追加（ユーザー/ガイド/両方の色分け）
  - トリガー説明のスタイル追加
  - チェックボックス用のスタイル追加（`.acceptance-checkbox`, `.checkbox-cell`）
  - ヒントアイコンのスタイル追加（`.section-title-hint`）
  - フィルタリングコントロールのスタイル追加（`.filter-controls`, `.filter-toggle`, `.filter-days-select`）
  - スマートフォン表示時のレスポンシブ対応（768px以下、480px以下）

### 3. データベース・Seeder
- `database/seeders/EmailTemplatesSeeder.php`
  - 新しいメールテンプレートを追加:
    - `user_registration_thanks`: ユーザー登録お礼
    - `guide_registration_thanks`: ガイド登録お礼
    - `reminder_same_day`: 当日リマインド
    - `reminder_day_before`: 前日リマインド
    - `reminder_report_missing`: 報告書未提出リマインド

### 4. サービス層
- `app/Services/EmailNotificationService.php`
  - 新しいテンプレートキーの通知種別マッピングを追加

### 5. 一括承認機能
- `app/Services/AdminService.php`
  - `batchApproveMatchings()`: 複数のマッチングを一括で承認するメソッドを追加

- `app/Http/Controllers/Api/AdminController.php`
  - `batchApproveMatchings()`: 一括承認APIエンドポイントを追加

- `routes/api.php`
  - `POST /api/admin/matchings/batch-approve`: 一括承認エンドポイントを追加

---

## 影響を受ける機能

### 1. APIエンドポイント

#### 受給者証番号関連
- `PUT /api/admin/users/{id}/profile-extra`
  - **変更前**: `recipient_number`は`nullable|string`のみ
  - **変更後**: `nullable|string|regex:/^\d{10}$/`（半角数字10桁必須）
  - **エラーメッセージ**: "受給者証番号は半角数字10桁で入力してください。"

- `PUT /api/admin/users/{id}/profile`
  - **変更前**: `recipient_number`は`nullable|string`のみ
  - **変更後**: `nullable|string|regex:/^\d{10}$/`（半角数字10桁必須）
  - **エラーメッセージ**: "受給者証番号は半角数字10桁で入力してください。"

#### 従業員番号関連
- `PUT /api/admin/guides/{id}/profile-extra`
  - **変更前**: `employee_number`は`nullable|string`のみ
  - **変更後**: `nullable|string|regex:/^\d{3}-\d{3}$/`（000-000形式必須）
  - **エラーメッセージ**: "従業員番号は000-000形式（半角数字6桁をハイフンで区切る）で入力してください。"

- `PUT /api/admin/guides/{id}/profile`
  - **変更前**: `employee_number`は`nullable|string`のみ
  - **変更後**: `nullable|string|regex:/^\d{3}-\d{3}$/`（000-000形式必須）
  - **エラーメッセージ**: "従業員番号は000-000形式（半角数字6桁をハイフンで区切る）で入力してください。"

### 2. フロントエンド機能

#### 管理者画面 - ユーザー管理
- **テーブル内の受給者証番号入力**
  - 半角数字のみ入力可能（自動フィルタリング）
  - 最大10文字まで
  - `maxlength="10"`、`pattern="\d{10}"`属性追加

- **ユーザープロフィールモーダル内の受給者証番号入力**
  - 半角数字のみ入力可能（自動フィルタリング）
  - 最大10文字まで
  - プレースホルダー: "半角数字10桁"

#### 管理者画面 - ガイド管理
- **テーブル内の従業員番号入力**
  - 000-000形式で自動フォーマット
  - 数字のみ入力可能
  - 3桁入力後に自動的にハイフン挿入
  - 最大7文字（000-000）
  - `maxlength="7"`、`pattern="\d{3}-\d{3}"`属性追加
  - プレースホルダー: "000-000"

- **ガイドプロフィールモーダル内の従業員番号入力**
  - 000-000形式で自動フォーマット
  - 数字のみ入力可能
  - 3桁入力後に自動的にハイフン挿入
  - 最大7文字（000-000）
  - プレースホルダー: "000-000"

### 3. エラーハンドリング
- バリデーションエラーメッセージを日本語で表示
- エラーレスポンスの構造を改善（`errors`オブジェクトに対応）
- 複数のエラーメッセージを改行区切りで表示

### 4. お知らせ管理機能

#### 管理者画面 - お知らせ一覧
- **タイトル欄の表示修正**
  - **変更前**: タイトル欄にタイトルと本文プレビュー（50文字）の両方が表示されていた
  - **変更後**: タイトル欄にはタイトルのみを表示
  - 本文の確認は編集ボタンから詳細を確認する必要がある

### 5. 承諾待ち一覧の一括承認機能

#### 管理者画面 - 承諾待ち一覧
- **チェックボックス列の追加**
  - 各承諾にチェックボックスを追加
  - 全選択チェックボックスをテーブルヘッダーに追加
  - ユーザーが選択していない承諾（`user_selected = false`）は選択不可（disabled）
  - 無効化されたチェックボックスには`title`属性で説明を表示

- **全選択/全解除機能**
  - テーブルヘッダーのチェックボックスで全選択/全解除が可能
  - 選択可能な承諾（`user_selected = true`）のみを対象とする
  - 一部のみ選択されている場合は中間状態（indeterminate）を表示

- **一括承認ボタン**
  - 選択された承諾が1件以上ある場合に表示
  - 選択件数をボタンに表示
  - クリックで選択されたすべての承諾を一度に承認

- **説明機能**
  - セクションヘッダーにヒントアイコン（ⓘ）を追加
  - ホバーで「ユーザーが選択したガイドのみ承認できます」を表示
  - 無効化されたチェックボックスにホバーで説明を表示

- **バックエンドAPI**
  - `POST /api/admin/matchings/batch-approve`: 一括承認エンドポイント
  - 複数のマッチングを一度に承認
  - 成功・失敗の結果を返す

- **非表示設定機能**
  - フィルタリング設定UI（チェックボックス + 日数選択ドロップダウン）
  - ローカルストレージに設定を保存（`hideOldAcceptances`, `hideOldAcceptancesDays`）
  - `getFilteredAcceptances()`: フィルタリング後の承諾リストを返す
  - `created_at`から現在までの日数を計算し、指定日数以上経過しているデータを非表示
  - フィルタリング後の件数表示
  - 一括選択/全解除はフィルタリング後のデータを対象

### 6. メールテンプレート管理機能

#### 管理者画面 - メールテンプレート編集
- **テンプレート一覧の改善**
  - 各テンプレートカードに送信先バッジを表示
    - ユーザー向け: 青色バッジ
    - ガイド向け: 黄色バッジ
    - ユーザー・ガイド向け: 紫色バッジ
  - 送信タイミング（トリガー）の説明を表示
  - テンプレートキーに基づいて自動的に送信先情報を表示

- **新規テンプレート作成フォームの改善**
  - 送信先選択フィールドを追加（ユーザー/ガイド/ユーザー・ガイド）
  - 既存のテンプレートキーを入力すると送信先が自動設定
  - 新規キーの場合は手動で送信先を選択可能
  - 送信先選択時にバッジが表示される

- **追加されたテンプレート**
  - `user_registration_thanks`: ユーザー登録お礼メール（ユーザー向け）
  - `guide_registration_thanks`: ガイド登録お礼メール（ガイド向け）
  - `reminder_same_day`: 当日リマインドメール（ユーザー・ガイド向け）
  - `reminder_day_before`: 前日リマインドメール（ユーザー・ガイド向け）
  - `reminder_report_missing`: 報告書未提出リマインドメール（ガイド向け）

- **既存テンプレート（管理者画面で編集可能）**
  - `report_submitted`: 報告書提出通知（ユーザー向け）
  - `report_approved`: 報告書承認通知（ガイド向け）
  - `request_notification`: 依頼通知（ガイド向け）
  - `matching_notification`: マッチング成立通知（ユーザー・ガイド向け）
  - `reminder_pending_request`: 承認待ち依頼リマインド（ユーザー向け）
  - `password_reset`: パスワードリセット（ユーザー・ガイド向け）

---

## 影響を受けない機能

以下の機能は変更の影響を受けません：

1. **データベーススキーマ**
   - テーブル構造、カラム定義に変更なし
   - 既存データへの影響なし（既存データはそのまま保持）

2. **データ取得（GET）エンドポイント**
   - すべてのGETエンドポイントは変更なし
   - データ表示に影響なし

3. **その他のプロフィール項目**
   - 連絡手段、備考、自己紹介など、他の項目への影響なし

4. **一般ユーザー・ガイド画面**
   - `resources/views/profile.blade.php`は変更なし
   - 受給者証番号・従業員番号は閲覧のみのため影響なし

5. **CSV出力機能**
   - CSV出力時のデータ形式に変更なし
   - 既存のデータはそのまま出力される

6. **お知らせ機能（表示修正以外）**
   - お知らせの作成・編集・削除機能に影響なし
   - APIエンドポイントに変更なし
   - データベーススキーマに変更なし
   - 一般ユーザー・ガイド向けのお知らせ表示に影響なし

7. **メール送信機能（テンプレート追加以外）**
   - 既存のメール送信ロジックに影響なし
   - メール送信APIエンドポイントに変更なし
   - メール送信のタイミングに変更なし

8. **個別承認機能**
   - 既存の個別承認機能（`approveMatching`）に影響なし
   - 個別承認の動作は変更なし

9. **データベース・API**
   - 非表示設定はフロントエンドのみの機能
   - データベースへの影響なし
   - APIエンドポイントへの影響なし
   - データは削除されず、表示のみ非表示になる

---

## 既存データへの影響

### データ整合性
- **既存の受給者証番号**: バリデーションエラーにはならないが、新規入力・更新時は10桁形式が必要
- **既存の従業員番号**: バリデーションエラーにはならないが、新規入力・更新時は000-000形式が必要

### 推奨対応
既存データが新しい形式に合致しない場合、以下の対応を推奨します：

1. **受給者証番号**
   - 既存データが10桁でない場合、管理者が手動で修正
   - 空欄の場合は新規入力時に10桁形式で入力

2. **従業員番号**
   - 既存データが000-000形式でない場合、管理者が手動で修正
   - 空欄の場合は新規入力時に000-000形式で入力

---

## テストが必要な箇所

### 1. バリデーションテスト
- [ ] 受給者証番号: 10桁の数字が正常に保存される
- [ ] 受給者証番号: 9桁以下でエラーが表示される
- [ ] 受給者証番号: 11桁以上でエラーが表示される
- [ ] 受給者証番号: 全角数字でエラーが表示される
- [ ] 受給者証番号: 文字列が含まれる場合にエラーが表示される
- [ ] 従業員番号: 000-000形式が正常に保存される
- [ ] 従業員番号: ハイフンなしでエラーが表示される
- [ ] 従業員番号: 形式が異なる場合にエラーが表示される
- [ ] 従業員番号: 自動フォーマットが正常に動作する

### 2. フロントエンドテスト
- [ ] 受給者証番号入力: 半角数字のみ入力可能
- [ ] 受給者証番号入力: 10文字を超える入力ができない
- [ ] 従業員番号入力: 自動フォーマットが正常に動作する
- [ ] 従業員番号入力: 3桁入力後にハイフンが自動挿入される
- [ ] エラーメッセージ: 日本語で適切に表示される
- [ ] モーダル内の入力: テーブル内入力と同様に動作する

### 3. API統合テスト
- [ ] バリデーションエラー時のレスポンス形式
- [ ] エラーメッセージの日本語表示
- [ ] 複数エラー時のメッセージ表示

### 4. 既存データ互換性テスト
- [ ] 既存の不正形式データが表示される（エラーにならない）
- [ ] 既存データの更新時にバリデーションが適用される

### 5. お知らせ一覧表示テスト
- [ ] タイトル欄にタイトルのみが表示される
- [ ] 本文プレビューがタイトル欄に表示されない
- [ ] タイトルが長い場合の表示が適切に折り返される
- [ ] 編集ボタンから本文を確認できる

### 6. メールテンプレート管理機能テスト
- [ ] テンプレート一覧に送信先バッジが表示される
- [ ] 送信先バッジの色分けが正しい（ユーザー/ガイド/両方）
- [ ] トリガー説明が正しく表示される
- [ ] 新規テンプレート作成時に送信先を選択できる
- [ ] 既存のテンプレートキーを入力すると送信先が自動設定される
- [ ] 新規キーの場合でも送信先を手動で選択できる
- [ ] 送信先選択時にバッジが表示される
- [ ] 新しいテンプレートがSeederで正しく追加される
- [ ] すべてのテンプレートが管理者画面で編集可能

### 7. 一括承認機能テスト
- [ ] チェックボックスが正しく表示される
- [ ] ユーザーが選択した承諾のみチェックボックスが有効
- [ ] ユーザーが選択していない承諾はチェックボックスが無効（disabled）
- [ ] 全選択チェックボックスで選択可能な承諾がすべて選択される
- [ ] 全選択チェックボックスで全解除ができる
- [ ] 一部のみ選択されている場合に中間状態（indeterminate）が表示される
- [ ] 一括承認ボタンが選択件数に応じて表示/非表示される
- [ ] 一括承認ボタンで選択された承諾が正しく承認される
- [ ] 一括承認の成功・失敗メッセージが正しく表示される
- [ ] ヒントアイコンのツールチップが正しく表示される
- [ ] 無効化されたチェックボックスの説明が正しく表示される

### 8. 非表示設定機能テスト
- [ ] 非表示設定のチェックボックスが正しく動作する
- [ ] 日数選択ドロップダウンが正しく表示される
- [ ] 設定がローカルストレージに保存される
- [ ] 次回訪問時に設定が復元される
- [ ] 30日以上経過したデータが非表示になる
- [ ] 60日以上経過したデータが非表示になる
- [ ] 90日以上経過したデータが非表示になる
- [ ] 180日以上経過したデータが非表示になる
- [ ] フィルタリング後の件数が正しく表示される
- [ ] 一括選択/全解除がフィルタリング後のデータを対象とする
- [ ] スマートフォン表示時のレイアウトが適切

---

## 移行時の注意点

### 1. デプロイ前
- 既存データの形式を確認
- 不正形式のデータがある場合は、事前に修正を検討

### 2. デプロイ後
- 管理者に新しい入力形式を周知
- 既存データの更新時に新しい形式に合わせるよう案内
- メールテンプレートSeederを実行して新しいテンプレートを追加
  ```bash
  php artisan db:seed --class=EmailTemplatesSeeder
  ```

### 3. ロールバック
- バリデーションルールを削除すれば、以前の動作に戻すことが可能
- フロントエンドの入力制御も同時に削除する必要がある

---

## 関連ドキュメント

- `REQUIREMENTS_GAP_ANALYSIS.md`: 要件定義との比較
- `API_SPECIFICATION.md`: API仕様書
- `ADMIN_FEATURES.md`: 管理者機能の説明

---

## 変更履歴

| 日付 | 変更内容 | 担当者 |
|------|---------|--------|
| 2026-02 | 初版作成（受給者証番号・従業員番号バリデーション追加） | - |
| 2026-02 | お知らせ一覧表示修正（タイトル欄の表示を修正） | - |
| 2026-02 | メールテンプレート管理機能改善（送信先情報表示、新規テンプレート追加） | - |
| 2026-02 | 承諾待ち一覧に一括承認機能追加（チェックボックス、全選択/全解除、一括承認ボタン） | - |
| 2026-02 | 承諾待ち一覧に非表示設定機能追加（長期間未承認データの非表示、日数設定、ローカルストレージ保存） | - |

